<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Generate Tiket SUKAPESTA</title>
<style>
body { font-family: Arial; padding: 20px; background: #f5f5f5; }
input { padding:10px; width:200px; margin-right:10px; }
button { padding:10px 15px; cursor:pointer; }
</style>
</head>
<body>

<h2>Generate Tiket SUKAPESTA</h2>
<label>Nomor Tiket:</label>
<input type="text" id="ticketNumber" placeholder="SP-00001" readonly>
<button onclick="generateTicket()">Generate</button>
<br><br>
<canvas id="ticketCanvas"></canvas>
<br>
<a id="downloadLink" download="ticket.png" style="display:none;">
  <button>Download Tiket</button>
</a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz6xkvZyezOVXxKjaIAzuQR5Gm6fiILenBou0_gbyftZCu-PVed5nvEvoCJyGmuxSzIYw/exec";

async function generateTicket() {
  try {
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'generate'})
    });
    const data = await resp.json();
    if(data.status!=='OK'){ alert('Gagal generate tiket'); return; }

    const ticketNum = data.kode;
    document.getElementById('ticketNumber').value = ticketNum;

    const canvas = document.getElementById('ticketCanvas');
    const ctx = canvas.getContext('2d');
    const template = await loadImage("ticket_template.png"); 
    canvas.width = template.width; canvas.height = template.height;
    ctx.drawImage(template,0,0);

    const qrCanvas = document.createElement("canvas");
    new QRCode(qrCanvas, {text: ticketNum, width:300, height:300});
    await new Promise(r=>setTimeout(r,500));

    ctx.drawImage(qrCanvas.querySelector("img"),140,255,300,300);
    ctx.font="bold 80px Arial"; ctx.fillStyle="#000"; ctx.textAlign="center";
    ctx.fillText(ticketNum, canvas.width-200,110);

    const link = document.getElementById("downloadLink");
    link.href = canvas.toDataURL();
    link.download = "TIKET_"+ticketNum+".png";
    link.style.display="inline-block";

  } catch(err) { alert("Error: "+err.message); }
}

function loadImage(url){
  return new Promise(resolve=>{
    const img = new Image();
    img.crossOrigin="anonymous";
    img.onload=()=>resolve(img);
    img.src=url;
  });
}
</script>
</body>
</html>
