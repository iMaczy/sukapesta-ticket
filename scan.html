<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sukapesta — Scanner</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap">
    <h2>Scanner Tiket — Sukapesta</h2>
    <div id="reader" style="width:100%"></div>
    <div id="result"></div>
    <hr/>
    <p>Atau masukkan kode manual:</p>
    <input id="manualId" placeholder="SP-00001"/>
    <button id="checkBtn">Cek</button>
  </div>

<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbypjGh80ABNO_xLQtlA09eeqTZ__KaZA2Hfz243M9l1SWFxvR-oa6KQ5CAJni4PD7e5zQ/exec";

function displayMessage(html){ document.getElementById('result').innerHTML = html; }

async function checkId(kode){
  try{
    const resp = await fetch(WEB_APP_URL, {
      method:'POST',
      body: JSON.stringify({ action:'check', kode }),
      headers: { 'Content-Type':'application/json' }
    });
    const data = await resp.json();

    if(data.status==='VALID') displayMessage(`<div class="good">✔ TIKET VALID & HANGUS — ${kode}</div>`);
    else if(data.status==='USED') displayMessage(`<div class="bad">❌ TIKET SUDAH DIGUNAKAN</div>`);
    else displayMessage(`<div class="bad">❌ KODE TIDAK DITEMUKAN</div>`);

  }catch(e){
    displayMessage(`<div class="bad">Error: ${e.message}</div>`);
  }
}

// tombol manual
document.getElementById('checkBtn').addEventListener('click', ()=>{
  const id = (document.getElementById('manualId').value||'').trim();
  if(id) checkId(id);
});

// scanner QR
const html5QrCode = new Html5Qrcode("reader");
html5QrCode.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  (decodedText, decodedResult) => {
    let id = decodedText.trim();
    checkId(id);
  },
  (errorMessage) => { /* ignore scan errors */ }
).catch(err=>displayMessage('<div class="bad">Camera error: '+err+'</div>'));
</script>

</body>
</html>
